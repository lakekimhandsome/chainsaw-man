<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>LAKE CHAINSAW MAN</title>

    <link rel="icon" href="favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="/android-chrome-192x192.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="512x512"
      href="/android-chrome-512x512.png"
    />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

    <style>
      body {
        margin: 0;
        background: rgb(255, 255, 255);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
      }

      #scene {
        position: relative;
        width: 300px;
        touch-action: none;
      }

      #inner {
        position: relative;
      }

      .char {
        width: 100%;
        display: block;
        user-select: none;
        pointer-events: none;
      }

      #denji {
        position: relative;
        z-index: 1;
      }

      #chainsawman {
        position: absolute;
        left: 0;
        top: -100px;
        z-index: 2;
        opacity: 0;
        transform: scale(1);
        transform-origin: 50% 100%;
      }

      #chainsawman.on {
        opacity: 1;
        transform: scale(1.7);
      }

      #inner.shake {
        animation: shake 0.3s linear infinite;
      }

      @keyframes shake {
        0% {
          transform: translate(0, 0);
        }
        25% {
          transform: translate(-3px, 2px);
        }
        50% {
          transform: translate(3px, -2px);
        }
        75% {
          transform: translate(-2px, -3px);
        }
        100% {
          transform: translate(0, 0);
        }
      }

      #trigger {
        position: absolute;
        width: 400px;
        height: 64px;
        left: -130px;
        top: 90px;
        background: url("assets/trigger.png") no-repeat center / contain;
        cursor: grab;
        transform: translateX(0);
        transition: transform 0.1s ease-out;
        touch-action: none;
        z-index: 3;
      }
    </style>
  </head>

  <body>
    <div id="scene">
      <div id="inner">
        <img id="denji" class="char" src="assets/denji.png" alt="Denji" />
        <img
          id="chainsawman"
          class="char"
          src="assets/chainsawman.png"
          alt="Chainsaw Man"
        />
        <div id="trigger" aria-label="pull trigger"></div>
      </div>
    </div>

    <!-- ✅ iOS에서 playsinline이 도움 되는 케이스가 있음 -->
    <audio
      id="sound"
      src="assets/kick_back.mp3"
      preload="auto"
      playsinline
    ></audio>

    <script>
      const trigger = document.getElementById("trigger");
      const sound = document.getElementById("sound");
      const inner = document.getElementById("inner");
      const chainsawman = document.getElementById("chainsawman");
      const denji = document.getElementById("denji");

      let startX = null;
      let activated = false;
      let transformed = false;

      // ✅ iOS 오디오 언락 플래그
      let audioUnlocked = false;

      sound.addEventListener("ended", resetToDenji);

      async function unlockAudioOnce() {
        if (audioUnlocked) return;
        audioUnlocked = true;

        // iOS: 첫 제스처에서 "무음 재생 -> 즉시 정지"로 권한 열기
        const prevMuted = sound.muted;
        sound.muted = true;
        try {
          sound.currentTime = 0;
          await sound.play();
          sound.pause();
          sound.currentTime = 0;
        } catch (e) {
          // 언락이 실패해도 다음 제스처에서 다시 시도 가능하게 롤백
          audioUnlocked = false;
        } finally {
          sound.muted = prevMuted;
        }
      }

      trigger.addEventListener("pointerdown", async (e) => {
        if (transformed) return;

        // ✅ 가장 중요: "터치 시작" 순간에 오디오 언락
        await unlockAudioOnce();

        startX = e.clientX;
        activated = false;
        trigger.setPointerCapture(e.pointerId);
      });

      trigger.addEventListener("pointermove", async (e) => {
        if (startX === null || transformed) return;

        const diff = startX - e.clientX; // 왼쪽 당기기(+)

        if (diff > 0) {
          trigger.style.transform = `translateX(${-Math.min(diff, 80)}px)`;
        }

        if (!activated && diff > 45) {
          activated = true;

          // ✅ 실제 재생은 여기서 (이미 pointerdown에서 언락이 되어 있음)
          try {
            sound.muted = false;
            sound.currentTime = 0;
            await sound.play();
          } catch (e2) {
            // 그래도 막히면: 다음 제스처에서 언락 다시 시도하게
            audioUnlocked = false;
          }

          transformNow();
        }
      });

      trigger.addEventListener("pointerup", resetTriggerIfNeeded);
      trigger.addEventListener("pointercancel", resetTriggerIfNeeded);

      function transformNow() {
        transformed = true;

        setTimeout(() => {
          inner.classList.add("shake");

          setTimeout(() => {
            denji.style.display = "none";
            chainsawman.classList.add("on");
            trigger.style.display = "none";
          }, 150);

          setTimeout(() => {
            inner.classList.remove("shake");
          }, 700);
        }, 400);
      }

      function resetTriggerIfNeeded() {
        if (!transformed) {
          startX = null;
          trigger.style.transform = "translateX(0)";
        }
      }

      function resetToDenji() {
        transformed = false;
        activated = false;
        startX = null;

        chainsawman.classList.remove("on");
        denji.style.display = "block";

        trigger.style.display = "block";
        trigger.style.transform = "translateX(0)";
        inner.classList.remove("shake");

        sound.pause();
        sound.currentTime = 0;
      }
    </script>
  </body>
</html>
